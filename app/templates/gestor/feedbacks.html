{% extends "base.html" %}
{% block title %}Feedbacks | Tower Control{% endblock %}

{% block extra_head %}
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<style>
  .star-material { font-size: 1.35rem; vertical-align: -4px;}
  .star-material-lg { font-size: 1.8rem; vertical-align: -5px;}
  .feedback-card {
    background: #fff;
    border-radius: 1rem;
    box-shadow: 0 2px 14px 0 rgba(20,70,120,0.09);
    padding: 1.5rem 2rem 1.5rem 1.2rem;
    position: relative;
    border: 1px solid #eef1f6;
    margin-bottom: .5rem;
  }
  .feedback-card .material-icons { vertical-align: -6px; }
</style>
{% endblock %}

{% block content %}
<div class="d-flex align-items-center justify-content-between mb-4">
  <h2 class="fw-bold mb-0">
    <span class="material-icons text-primary" style="vertical-align:-5px;">forum</span>
    Feedbacks
  </h2>
  <a href="{{ url_for('feedback.feedbacks_novo') }}" class="btn btn-primary shadow-sm">
    <span class="material-icons me-1">add_circle</span> Novo Feedback
  </a>
</div>

<form method="get" class="mb-4">
  <div class="row g-2 align-items-center">
    <div class="col-auto">
      <label class="form-label mb-0">Filtrar por usuário:</label>
    </div>
    <div class="col-auto">
      <select name="colaborador" class="form-select" onchange="this.form.submit()">
        <option value="">Todos</option>
        {% for c in colaboradores %}
          <option value="{{ c.id }}" {% if filtro_id and c.id == filtro_id|int %}selected{% endif %}>
            {{ c.nome }} ({{ c.email }})
          </option>
        {% endfor %}
      </select>
    </div>
  </div>
</form>

<!-- Ranking/Pontuação média dos usuários -->
<div class="row row-cols-1 row-cols-md-3 g-4 mb-4">
  {% for c in colaboradores %}
    <div class="col">
      <div class="card border-0 shadow-sm text-center py-3">
        <div class="fw-semibold mb-1">{{ c.nome }}</div>
        <div class="text-muted small mb-1">{{ c.email }}</div>
        {% set media, qtd = media_dict.get(c.id, (0,0)) %}
        <div>
          {% for i in range(1,6) %}
            {% if i <= media|round(0,'floor') %}
              <span class="material-icons star-material text-warning">star</span>
            {% else %}
              <span class="material-icons star-material text-warning">star_border</span>
            {% endif %}
          {% endfor %}
          <span class="ms-1 text-muted fs-6">{{ media|round(1) }} / 5</span>
          <span class="badge bg-info bg-opacity-10 text-info ms-2">{{ qtd }} feedback(s)</span>
        </div>
      </div>
    </div>
  {% endfor %}
</div>

{% if feedbacks %}
  <div class="row row-cols-1 g-4">
    {% for fb in feedbacks %}
      <div class="col">
        <div class="feedback-card position-relative">
          <div class="d-flex align-items-center mb-2">
            <span class="material-icons fs-2 me-2 text-secondary" style="font-size:2.5rem;">person</span>
            <div>
              <span class="fw-bold">{{ fb.user.nome }}</span>
              <small class="text-muted d-block">
                por {{ fb.gestor.nome }}
                &middot; {{ fb.data.strftime('%d/%m/%Y %H:%M:%S') }}
              </small>
            </div>
          </div>
          <div class="mb-2" style="font-size: 1.07rem;">{{ fb.texto }}</div>
          <div class="mb-1">
            {% for i in range(1,6) %}
              {% if i <= fb.nota %}
                <span class="material-icons star-material-lg text-warning">star</span>
              {% else %}
                <span class="material-icons star-material-lg text-warning">star_border</span>
              {% endif %}
            {% endfor %}
            <span class="text-muted small ms-2">{{ fb.nota }} / 5</span>
          </div>
          <div class="d-flex gap-2 position-absolute end-0 bottom-0 me-3 mb-3">

          </div>
        </div>
      </div>
    {% endfor %}
  </div>
{% else %}
  <div class="alert alert-info mt-4">Nenhum feedback encontrado.</div>
{% endif %}
{% endblock %}
