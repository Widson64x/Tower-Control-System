{% extends 'base.html' %}

{% block title %}Jornada dos Heróis | Tower Control{% endblock %}

{% block styles %}
{{ super() }}
<style>
    .timeline-wrapper { max-width: 1200px; margin: 0 auto; }
    .timeline::after { content: ''; position: absolute; width: 4px; background-color: #e9ecef; top: 0; bottom: 0; left: 50%; margin-left: -2px; z-index: 1; animation: grow-line 1s ease-out forwards; transform-origin: top; }
    .timeline-container { padding: 10px 40px; position: relative; background-color: inherit; width: 50%; z-index: 2; opacity: 0; animation: fade-in-up 0.6s ease-out forwards; }
    .timeline-container.left { left: 0; }
    .timeline-container.right { left: 50%; }
    .timeline-container::after { content: ''; position: absolute; width: 25px; height: 25px; right: -14px; background-color: white; border: 4px solid var(--bs-primary); top: 35px; border-radius: 50%; z-index: 2; transform: scale(0); animation: pop-in 0.3s 0.5s ease-out forwards; }
    .timeline-container.right::after { left: -14px; }
    .timeline-content { padding: 20px; background-color: white; position: relative; border-radius: 12px; border: 1px solid #dee2e6; box-shadow: 0 4px 15px rgba(0,0,0,0.07); }
    .timeline-icon { position: absolute; top: 38px; font-size: 1.5rem; color: var(--bs-primary); }
    .timeline-container.left .timeline-icon { right: 55px; }
    .timeline-container.right .timeline-icon { left: 55px; }
    .reaction-btn { background-color: #f0f2f5; border: 1px solid #f0f2f5; transition: all 0.2s ease-in-out; }
    .reaction-btn.active { background-color: #e0edff; border-color: var(--bs-primary); color: var(--bs-primary); font-weight: 500;}
    .comment-box { background-color: #f8f9fa; border-radius: 8px; padding: 8px 12px; margin-bottom: 8px; }
    .filter-btn-group .btn { border-radius: 50rem; }

    @keyframes grow-line { from { transform: scaleY(0); } to { transform: scaleY(1); } }
    @keyframes fade-in-up { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes pop-in { from { transform: scale(0); } to { transform: scale(1); } }

    .skeleton { background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 200% 100%; animation: skeleton-shine 1.5s infinite linear; }
    .skeleton-text { height: 1em; margin-bottom: 0.5em; border-radius: 4px; }
    @keyframes skeleton-shine { to { background-position: -200% 0; } }
</style>
{% endblock %}

{% block content %}
<div class="timeline-wrapper">
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
        <h1 class="fw-bold text-primary mb-0"><i class="bi bi-compass me-3"></i>Jornada dos Heróis</h1>
        <a href="{{ url_for('jornadas.adicionar_jornada') }}" class="btn btn-success btn-lg shadow-sm">
            <i class="bi bi-plus-circle me-2"></i> Adicionar Marco
        </a>
    </div>

    <div class="card shadow-sm mb-5">
        <div class="card-body d-flex justify-content-center p-3">
            <div class="btn-group filter-btn-group" role="group" aria-label="Filtros da Jornada">
                <button type="button" class="btn btn-outline-primary active" data-filter="todos">Todos</button>
                <button type="button" class="btn btn-outline-primary" data-filter="Individual">Individuais</button>
                <button type="button" class="btn btn-outline-primary" data-filter="Time">Times</button>
                <button type="button" class="btn btn-outline-primary" data-filter="Empresa">Empresa</button>
            </div>
        </div>
    </div>

    <div id="skeleton-loader" class="timeline">
        {% for i in range(2) %}
        <div class="timeline-container {% if loop.index is odd %}left{% else %}right{% endif %}" style="opacity:1; animation: none;">
            <div class="timeline-content">
                <div class="skeleton skeleton-text" style="width: 60%; height: 1.5em; margin-bottom: 1em;"></div>
                <div class="skeleton skeleton-text" style="width: 90%;"></div>
                <div class="skeleton skeleton-text" style="width: 70%;"></div>
            </div>
        </div>
        {% endfor %}
    </div>

    <div id="timeline" class="timeline" style="display: none;"></div>
    
    <div id="timeline-message" class="text-center my-5" style="display: none;"></div>
</div>
{% endblock %}


{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const timelineEl = document.getElementById('timeline');
    const skeletonLoaderEl = document.getElementById('skeleton-loader');
    const messageEl = document.getElementById('timeline-message');
    const filterButtons = document.querySelectorAll('.filter-btn-group .btn');

    const renderJornadaCard = (item, side) => `
        <div class="timeline-container ${side}" data-id="${item.id}" style="animation-delay: ${side === 'left' ? 0.1 : 0.2}s">
            <div class="timeline-content">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <i class="bi ${item.icone || 'bi-flag'} timeline-icon"></i>
                        <h2 class="h5 mb-1">${item.titulo}</h2>
                        <small class="text-muted">${item.data_jornada}</small>
                    </div>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-light py-0 px-2" type="button" data-bs-toggle="dropdown"><i class="bi bi-three-dots-vertical"></i></button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="/jornada/editar/${item.id}"><i class="bi bi-pencil me-2"></i>Editar</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><form action="/jornada/deletar/${item.id}" method="POST" onsubmit="return confirm('Tem certeza?');"><button type="submit" class="dropdown-item text-danger"><i class="bi bi-trash me-2"></i>Deletar</button></form></li>
                        </ul>
                    </div>
                </div>
                ${item.descricao ? `<p class="mt-3">${item.descricao}</p>` : ''}
                <div class="mt-2">
                    ${item.employee ? `<span class="badge bg-light text-dark me-1"><i class="bi bi-person"></i> ${item.employee}</span>` : ''}
                    ${item.team ? `<span class="badge bg-light text-dark me-1"><i class="bi bi-people"></i> ${item.team}</span>` : ''}
                    ${item.categoria ? `<span class="badge bg-info text-dark me-1"><i class="bi bi-tag"></i> ${item.categoria}</span>` : ''}
                </div>
                <hr>
                <div class="d-flex gap-2 mb-3">
                    ${['aplauso', 'foguete', 'trofeu'].map(r => `<button class="btn btn-sm reaction-btn ${item.user_reacoes.includes(r) ? 'active' : ''}" onclick="reagir(this, ${item.id}, '${r}')">${r === 'aplauso' ? '👏' : r === 'foguete' ? '🚀' : '🏆'} <span class="count">${item.reacoes_contagem[r] || 0}</span></button>`).join('')}
                </div>
                <div class="comments-section">
                    <div class="comment-list">${item.comentarios.map(c => `<div class="comment-box small"><strong>${c.user}:</strong> ${c.texto} <span class="text-muted float-end">${c.data}</span></div>`).join('')}</div>
                    <form class="comment-form" onsubmit="postarComentario(event, ${item.id})">
                        <div class="input-group"><input type="text" class="form-control form-control-sm" placeholder="Adicionar um comentário..." name="comentario" required><button class="btn btn-outline-secondary btn-sm" type="submit">Postar</button></div>
                    </form>
                </div>
            </div>
        </div>
    `;

    const showMessage = (type, text) => {
        messageEl.className = `alert alert-${type} text-center`;
        messageEl.innerHTML = text;
        messageEl.style.display = 'block';
    };
    
    async function carregarJornada(filtro = null) {
        timelineEl.style.display = 'none';
        messageEl.style.display = 'none';
        skeletonLoaderEl.style.display = 'block';
        
        let url = "{{ url_for('jornadas.api_dados_jornada') }}";
        if (filtro) url += `?tipo=${filtro}`;

        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const data = await response.json();
            
            skeletonLoaderEl.style.display = 'none';
            timelineEl.innerHTML = '';

            if (data && data.length > 0) {
                let side = 'left';
                data.forEach(item => {
                    timelineEl.innerHTML += renderJornadaCard(item, side);
                    side = (side === 'left') ? 'right' : 'left';
                });
                timelineEl.style.display = 'block';
            } else {
                showMessage('info', 'Nenhum marco encontrado para este filtro.');
            }
        } catch (error) {
            console.error("Falha ao carregar a jornada:", error);
            skeletonLoaderEl.style.display = 'none';
            showMessage('danger', 'Ocorreu um erro ao carregar a jornada. Tente recarregar a página.');
        }
    }

    filterButtons.forEach(button => {
        button.addEventListener('click', () => {
            filterButtons.forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            const filtro = button.dataset.filter === 'todos' ? null : button.dataset.filter;
            carregarJornada(filtro);
        });
    });

    carregarJornada(); // Carga inicial
});

async function reagir(button, jornadaId, tipoReacao) {
    const isActive = button.classList.contains('active');
    const countSpan = button.querySelector('.count');
    const currentCount = parseInt(countSpan.textContent);
    
    button.classList.toggle('active');
    countSpan.textContent = isActive ? currentCount - 1 : currentCount + 1;
    
    try {
        await fetch("{{ url_for('jornadas.api_reagir') }}", { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ jornada_id: jornadaId, tipo_reacao: tipoReacao }) });
    } catch (error) {
        console.error("Erro ao reagir:", error);
        button.classList.toggle('active'); // Reverte
        countSpan.textContent = currentCount;
    }
}

async function postarComentario(event, jornadaId) {
    event.preventDefault();
    const form = event.target;
    const input = form.querySelector('input[name="comentario"]');
    const button = form.querySelector('button');
    const comentarioTexto = input.value.trim();
    if (!comentarioTexto) return;

    const originalButtonHtml = button.innerHTML;
    button.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
    input.disabled = true;

    try {
        const response = await fetch("{{ url_for('jornadas.api_comentar') }}", { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ jornada_id: jornadaId, comentario: comentarioTexto }) });
        const data = await response.json();
        if (data.status === 'sucesso') {
            const commentList = form.closest('.comments-section').querySelector('.comment-list');
            commentList.insertAdjacentHTML('beforeend', `<div class="comment-box small"><strong>${data.comentario.user}:</strong> ${data.comentario.texto} <span class="text-muted float-end">${data.comentario.data}</span></div>`);
            input.value = '';
        }
    } catch (error) {
        console.error("Erro ao comentar:", error);
    } finally {
        button.innerHTML = originalButtonHtml;
        input.disabled = false;
    }
}
</script>
{% endblock %}